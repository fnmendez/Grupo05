<p id="notice"><%= notice %></p>

<p>
  <h1>Title: <%= @chapter.title %> </h1>
</p>

<p>
  <strong>Status:</strong>
  <% if @view.exists? %>
    Viewed. <%= link_to 'Mark as unseen', @view.first, method: :delete %>
  <% else %>
    Not yet seen. <%= link_to 'Mark as Seen', new_chapter_view_path(@chapter) %>
  <% end %>
</p>

<p>
  <strong>Summary:</strong>
  <%= @chapter.summary %>
</p>

<p>
  <strong>Added by:</strong>
  <%= @chapter.user.username %>
</p>

<p>
  <strong>Season:</strong>
  <%= @chapter.season.number %>
</p>

<p>
  <strong>Actors:</strong>
    <% @chapter.actors.each do |actor| %>
      <%= actor.name %>
      <%= link_to 'Destroy', actor, method: :delete, data: { confirm: 'Are you sure?' } %>,
    <% end %>

</p>

<p>
  <strong>Directors:</strong>
    <% @chapter.directors.each do |director| %>
      <%= director.name %>
      <%= link_to 'Destroy', director, method: :delete, data: { confirm: 'Are you sure?' } %>,
    <% end %>
</p>

<% if user_signed_in? %>
  <p>
    <strong>Your Rating:</strong>
    <% if @chapter_rating.exists? %>
      <%= @chapter_rating.first.stars %>
      <%= link_to 'Edit', edit_chapter_rating_path(@chapter_rating.first) %>
    <% elsif @view.exists? %>
      <%= link_to 'Rate Chapter', new_chapter_chapter_rating_path(@chapter) %>
    <% else %>
      In order to rate this chapter, you have to mark it as seen.
    <% end %>
  </p>
<% end %>

<p>
  <strong>Rating Avg:</strong>
  <% @total = 0 %>
  <% @chapter_ratings.each do |r| %>
    <% @total += r.stars %>
  <% end %>
  <%= @total %>
</p>

<% if user_signed_in? %>
  <p>
    <strong>Reviews:</strong>
    <% if @view.exists? %>
      <%= link_to 'New Review', new_chapter_chapter_review_path(@chapter) %>
    <% else %>
      In order to create a review for this chapter, you have to mark it as seen.
    <% end %>
    <% if @chapter_reviews.exists? %>
      <table>
        <thead>
          <tr>
            <th>
              User
            </th>
            <th>
              Content
            </th>
          </tr>
        </thead>
        <tbody>
          <% @chapter_reviews.each do |rv| %>
            <tr>
              <td><%= rv.view.user.username %></td>
              <td><%= rv.content %></td>
              <% if rv.view.user == current_user %>
                <td><%= link_to 'Edit', edit_chapter_review_path(rv) %></td>
              <% end %>
              <% if rv.view.user == current_user || current_user.is_admin? %>
                <td><%= link_to 'Destroy', rv, method: :delete %></td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </p>
<% end %>

<% if user_signed_in? && (current_user.is_admin? || @chapter.season.serie.user == current_user) %>
  <%= link_to 'Edit', edit_chapter_path(@chapter) %> |
  <%= link_to 'Destroy', @chapter, method: :delete, data: { confirm: 'Are you sure?' } %> |
<% end %>
<%= link_to 'Back', @chapter.season %>
